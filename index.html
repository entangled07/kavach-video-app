<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAVACH: Video-Centric Learning (READY FOR HOSTING)</title>
    
    <!-- EMBEDDED TAILWIND CSS -->
    <style>
        /* Base styles */
        :root {
            --primary: #4F46E5; /* Indigo-600 */
            --secondary-bg: #e0e7ff; /* Indigo-100 */
            --video-bg: #111827; /* Dark Grey/Black */
        }
        .font-sans { font-family: Inter, ui-sans-serif, system-ui, sans-serif; }
        .min-h-screen { min-height: 100vh; }
        .bg-gray-50 { background-color: #f9fafb; }
        .max-w-7xl { max-width: 80rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        /* Layout & Spacing */
        .p-4 { padding: 1rem; }
        .sm\:p-8 { padding: 2rem; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .aspect-video { aspect-ratio: 16 / 9; }

        /* Colors and Components */
        .bg-primary { background-color: var(--primary); }
        .text-white { color: #fff; }
        .p-6 { padding: 1.5rem; }
        .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-t-2xl { border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .font-bold { font-weight: 700; }
        .text-indigo-200 { color: #c7d2fe; }
        .mt-1 { margin-top: 0.25rem; }

        /* Video Player Area */
        .video-player-container { background-color: var(--video-bg); padding: 0.5rem; border-radius: 1rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .video-iframe { border-radius: 0.5rem; }
        .video-overlay { z-index: 10; cursor: pointer; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .transition-all { transition: all 0.3s ease-in-out; }
        
        /* Module List Styling */
        .module-list-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        @media (min-width: 640px) { 
            .module-list-container {
                grid-template-columns: repeat(4, 1fr); 
            }
        }
        @media (min-width: 1024px) { 
            .module-list-container {
                grid-template-columns: repeat(7, 1fr); 
            }
        }
        
        .module-card {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .module-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .module-card.active {
            border-color: var(--primary);
            background-color: var(--secondary-bg);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.3);
            transform: scale(1.03);
        }
        
        /* Gemini Result Styling */
        .ai-result {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #fff;
            border: 1px solid #e0e7ff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="font-sans bg-gray-50 min-h-screen">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-8">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <script type="module">
        // --- Firebase SDK Imports (For Canvas Environment only) ---
        let initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, setLogLevel;

        // --- GLOBAL FIREBASE/APP VARIABLES (Mandatory for Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = ""; // Gemini API Key Placeholder
        
        let app, db, auth;
        let userId = 'Anonymous (Local)'; 
        
        // --- KAVACH Core Application Logic ---
        
        // EMBEDDED CONTENT: FINAL YOUTUBE LINKS
        const EMBEDDED_KAVACH_DATA_RAW = 
[
{
"topicTitle": "KAVACH",
"sections": [
{
"sectionTitle": "Module 1",
"videos": [
{
"title": "Video 1: Core Architecture Overview",
"description": "This video explains the core offline-first strategy and components (VOLLEY, GSON).",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/L9SMgB5QNOs?rel=0" } 
]
}
]
},
{
"sectionTitle": "Module 2",
"videos": [
{
"title": "Video 2: Caching and Fallback Logic",
"description": "This video details how the app saves data locally (caching) and ensures seamless offline function (fallback).",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/JsokzsfFFmk?rel=0" }
]
}
]
},
{
"sectionTitle": "Module 3",
"videos": [
{
"title": "Video 3: Structuring JSON Content",
"description": "This video covers the data model (Topic, Module, Video) and how JSON is parsed into Kotlin objects.",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/MDHElMgya4k?rel=0" }
]
}
]
},
{
"sectionTitle": "Module 4",
"videos": [
{
"title": "Video 4: Implementing Expandable List",
"description": "This video walks through the UI implementation of the collapsible list view (TopicAdapter.kt).",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/5882emtXmag?rel=0" }
]
}
]
},
{
"sectionTitle": "Module 5",
"videos": [
{
"title": "Video 5: Embedded Player Configuration",
"description": "This video explains setting up and optimizing the EXOPLAYER component for video streaming.",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/9_rOF6GrQr8?rel=0" }
]
}
]
},
{
"sectionTitle": "Module 6",
"videos": [
{
"title": "Video 6: Manual Stream Switching",
"description": "This video covers implementing the dedicated button/dialog for changing video quality (720p to 360p) for bandwidth control.",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/JuvA7ONSUvw?rel=0" }
]
}
]
},
{
"sectionTitle": "Module 7",
"videos": [
{
"title": "Video 7: Web vs. Native Deployment",
"description": "A comparative overview of deploying the KAVACH architecture on web vs. native platforms.",
"videoStreams": [
{ "quality": "720p", "url": "https://www.youtube.com/embed/yR7L8t_H2oQ?rel=0" }
]
}
]
}
]
}
];
        
        const EMBEDDED_KAVACH_DATA = EMBEDDED_KAVACH_DATA_RAW[0];

        const CACHE_KEY = 'kavach_content_cache';
        const MOCK_FETCH_DELAY = 100;
        
        let appData = null; 
        let currentStatus = 'Initializing...';
        let isOffline = false;
        let isAuthReady = false;
        let simulatedSpeed = '1.2 Mbps'; // Default speed simulation
        
        let currentVideo = null; 
        let currentVideoTitle = "KAVACH - Loading...";
        let currentVideoUrl = ""; 
        let currentModuleTitle = "";
        let currentVideoDescription = ""; // New: Store description for AI use

        let aiResultText = ""; // State for AI output text
        let isAiLoading = false; // State for AI loading indicator

        // --- GEMINI API UTILITY ---

        // Function to call the Gemini LLM
        async function callGemini(prompt, systemInstruction) {
            isAiLoading = true;
            aiResultText = "Generating response... Please wait.";
            renderApp(); // Show loading state

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            try {
                let response;
                let attempt = 0;
                const maxAttempts = 3;
                let delay = 1000;

                while (attempt < maxAttempts) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status !== 429) { // 429 is Too Many Requests (retry)
                        break;
                    }
                    console.warn(`Rate limit hit (429). Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                    attempt++;
                }

                if (!response.ok) {
                     const errorText = await response.text();
                     throw new Error(`API Request failed with status ${response.status}. ${errorText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) throw new Error("Gemini returned an empty response.");
                return text;

            } catch (error) {
                console.error("Gemini API Error:", error);
                return `[Error] Failed to connect to AI service: ${error.message}. Please check your connection and API key.`;
            } finally {
                isAiLoading = false;
            }
        }
        
        // Function to generate Q&A for the module
        window.generateQnA = async () => {
            const topic = currentVideoTitle;
            const description = currentVideoDescription;
            const prompt = `Based on this video topic: "${topic}" and description: "${description}", generate a list of 3-4 thought-provoking questions suitable for a student to reflect on after watching the video.`;
            const systemInstruction = "You are a concise educational assistant. Format the output as a simple numbered list of questions, nothing else.";
            
            aiResultText = await callGemini(prompt, systemInstruction);
            renderApp();
        };

        // Function to summarize/expand the video title
        window.summarizeTopic = async () => {
            const topic = currentVideoTitle;
            const description = currentVideoDescription;
            const prompt = `Provide a single, concise paragraph (max 4 sentences) that summarizes the topic "${topic}" and its relevance to the KAVACH app architecture.`;
            const systemInstruction = "You are a helpful technical summarizer. Ensure the output is clean Markdown/plain text, starting immediately with the summary.";
            
            aiResultText = await callGemini(prompt, systemInstruction);
            renderApp();
        };


        // --- Utility Functions ---
        
        const getIcon = (name, classes) => {
            const icons = {
                'Wifi': '<path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.05 9.14a16 16 0 0 1 21.9 0"/><path d="M9 16.18a5.5 5.5 0 0 1 6.04 0"/><line x1="12" y1="20" x2="12.01" y2="20"/>',
                'WifiOff': '<line x1="2" y1="2" x2="22" y2="22"/><path d="M8.5 12.55a11 11 0 0 1 11.08 0"/><path d="M12.5 16.18a5.5 5.5 0 0 1-2.92 0"/><path d="M2.05 9.14a16 16 0 0 1 3.4-1.63"/><path d="M16.96 11.5c1.32-.4 2.58-.9 3.8-1.57"/>',
                'Loader': '<path d="M21 12a9 9 0 1 1-6.219-8.56"/>',
                'Play': '<polygon points="5 3 19 12 5 21 5 3"/>',
                'Video': '<path d="m22 8-6 4 6 4V8Z"/><rect x="2" y="4" width="14" height="16" rx="2"/>',
                'AlertTriangle': '<path d="M10.29 3.86L2.94 18.23a2 2 0 0 0 1.71 2.77h14.7a2 2 0 0 0 1.71-2.77L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'
            };
            return `<svg class="w-5 h-5 ${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icons[name] || ''}</svg>`;
        };
        
        // --- Core UI Rendering ---

        const renderApp = () => {
            const container = document.getElementById('app-container');
            if (!container) return;

            // Determine status bar colors and icons
            const statusColor = isOffline ? 'bg-red-500' : 'bg-green-500';
            const iconName = isOffline ? 'WifiOff' : 'Wifi';
            const speedText = isOffline ? 'Offline' : simulatedSpeed;
            const statusTextColor = isOffline ? 'text-red-800' : 'text-green-800';
            const topicTitle = appData ? appData.topicTitle : 'KAVACH';
            
            let contentHtml = '';

            if (currentStatus.includes('Loading')) {
                contentHtml = `
                    <div class="flex justify-center items-center h-48 bg-white rounded-xl shadow-md mt-6">
                        ${getIcon('Loader', 'w-8 h-8 animate-spin text-primary mr-3')}
                        <span class="text-lg text-gray-600">Loading content...</span>
                    </div>
                `;
            } else if (appData && appData.sections) {
                contentHtml = `
                    <div class="video-player-and-controls">
                        ${renderVideoPlayer()}
                        ${renderVideoDetails()}
                        ${renderAiResult()}
                        ${renderModuleNavigation(appData.sections)}
                    </div>
                `;
            } else {
                contentHtml = `
                    <div class="p-8 text-center bg-red-50 rounded-xl border border-red-300 mt-6">
                        ${getIcon('AlertTriangle', 'w-8 h-8 text-red-600 mx-auto mb-3')}
                        <p class="text-xl text-red-800">Critical Error: Content Unavailable</p>
                        <p class="text-red-600">The embedded application data is missing or corrupted.</p>
                    </div>
                `;
            }


            let headerHtml = `
                <header class="bg-primary text-white p-6 rounded-t-2xl shadow-xl">
                    <h1 class="text-3xl font-bold">${topicTitle}</h1>
                    <p class="text-indigo-200 mt-1">Zero-Maintenance, Offline-First Video Library</p>
                </header>
                
                <!-- Enhanced Status Bar -->
                <div class="p-3 shadow-lg mb-6 flex justify-between items-center bg-white rounded-b-lg">
                    <div class="flex items-center space-x-2">
                        <!-- Status DOT (Green/Red) -->
                        <div class="w-3 h-3 rounded-full ${isOffline ? 'bg-red-500' : 'bg-green-500'}"></div>
                        <!-- Status Text -->
                        <span id="status-text" class="text-sm font-medium ${isOffline ? 'text-red-800' : 'text-green-800'}">
                            ${currentStatus.split(' (')[0]}
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-3 text-sm text-gray-600">
                        <!-- Network Speed/Status Indicator -->
                        <span class="font-mono text-xs font-semibold ${isOffline ? 'text-red-500' : 'text-green-600'}">
                            ${speedText}
                        </span>
                        <!-- Wifi Icon -->
                        ${getIcon(iconName, `w-5 h-5 ${isOffline ? 'text-red-500' : 'text-green-500'}`)}
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-6 p-4 bg-white rounded-xl shadow-md">
                    <span class="text-gray-700 font-medium whitespace-nowrap">User ID:</span>
                    <span class="truncate font-mono text-xs text-gray-500 bg-gray-100 p-2 rounded">${userId}</span>
                    <button id="toggle-network-btn" class="px-4 py-2 rounded-lg text-sm transition-all shadow-sm whitespace-nowrap
                        ${isOffline ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-green-500 text-white hover:bg-green-600'}"
                    >
                        ${isOffline ? 'Force Offline (Load Cache)' : 'Network ON (Live Data)'}
                    </button>
                    <button id="clear-cache-btn" class="px-4 py-2 rounded-lg text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all shadow-sm whitespace-nowrap">
                        Clear Cache & Reload
                    </button>
                </div>
            `;

            container.innerHTML = headerHtml + contentHtml;
            attachEventListeners();
        };

        // --- Video Player Rendering (Using reliable YouTube iFrame) ---

        const renderVideoPlayer = () => {
            
            const videoElement = isOffline ? `
                <div class="absolute inset-0 flex items-center justify-center text-center text-white/50">
                    ${getIcon('CloudOff', 'w-10 h-10 mb-3')}
                    <p class="text-lg">Video streaming blocked in offline mode. Please connect to the internet.</p>
                </div>
            ` : `
                <iframe
                    src="${currentVideoUrl}"
                    width="100%"
                    height="100%"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                    frameborder="0"
                    loading="lazy"
                    class="video-iframe"
                ></iframe>
            `;

            return `
                <div class="video-player-container">
                    <div class="aspect-video w-full relative">
                        ${videoElement}
                    </div>
                </div>
            `;
        };
        
        // --- Video Details and Controls Rendering ---

        const renderVideoDetails = () => {
            const qualityButtons = ['1080p', '720p', '360p'].map(q => `
                <button onclick="window.setVideoQuality('${q}')"
                    class="px-4 py-1 text-sm font-semibold rounded-full transition-all 
                        ${currentVideo.quality === q ? 'bg-indigo-700 text-white shadow-lg' : 'bg-gray-700 text-gray-200 hover:bg-gray-600'}
                    "
                >
                    ${q}
                </button>
            `).join('');
            
            const simpleVideoTitle = currentVideoTitle.split(':')[0].trim();

            return `
                <div class="p-4 bg-white rounded-xl shadow-lg mt-4">
                    <h2 class="text-2xl font-bold text-gray-800">${simpleVideoTitle}</h2>
                    <p class="text-sm text-primary font-semibold mb-3">${currentModuleTitle}</p>
                    
                    <div class="flex flex-wrap items-center justify-between bg-gray-800 p-3 rounded-xl shadow-inner mt-2">
                        <span class="font-medium text-gray-200 mb-2 sm:mb-0 w-full sm:w-auto text-sm sm:text-base">
                            Simulated Quality Control:
                        </span>
                        <div class="flex space-x-2">
                            ${qualityButtons}
                        </div>
                        <span class="w-full text-xs text-indigo-400 mt-2">
                            Current stream simulated at: ${currentVideo.quality}. (Player uses external streaming service).
                        </span>
                    </div>

                    <!-- NEW: Gemini AI Interaction Panel -->
                    <div class="mt-4 pt-4 border-t border-gray-200 flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3">
                        <button onclick="window.generateQnA()"
                            class="flex-grow py-3 rounded-xl text-white font-semibold transition-all bg-secondary hover:bg-emerald-500 shadow-md flex items-center justify-center disabled:opacity-50"
                            id="qna-button" disabled
                        >
                            ${isAiLoading ? 'Generating Questions...' : '✨ Generate Q&A Prompts'}
                        </button>
                        <button onclick="window.summarizeTopic()"
                            class="flex-grow py-3 rounded-xl text-white font-semibold transition-all bg-primary hover:bg-indigo-700 shadow-md flex items-center justify-center disabled:opacity-50"
                            id="summary-button" disabled
                        >
                            ${isAiLoading ? 'Summarizing...' : '✨ Summarize Topic'}
                        </button>
                    </div>
                </div>
            `;
        };

        // --- Gemini AI Result Renderer ---
        const renderAiResult = () => {
            if (!aiResultText) return '';

            let content = aiResultText;
            
            // Basic Markdown to HTML conversion for lists/bolding
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/(\d+\.\s.*)/g, '<li class="ml-4 list-decimal">$1</li>');
            content = content.replace(/\s*<li>/g, '<li>').replace(/<\/li>\s*<li>/g, '</li><li>');
            if (content.includes('<li>')) {
                content = `<ol class="space-y-1">${content}</ol>`;
            } else {
                content = `<p>${content}</p>`;
            }

            return `
                <div class="ai-result">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-primary mr-2"><path d="M12 2a10 10 0 0 0-7.07 17.07l2.83-2.83"/><path d="M12 2a10 10 0 0 1 7.07 17.07l-2.83-2.83"/><line x1="8" y1="16" x2="16" y2="8"/></svg>
                        AI Insight:
                    </h4>
                    <div class="text-gray-700 text-sm leading-relaxed">
                        ${isAiLoading ? '<div class="flex items-center text-primary"><svg class="w-5 h-5 animate-spin mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-6.219-8.56"></path></svg> Generating response...</div>' : content}
                    </div>
                </div>
            `;
        };

        // --- Module Navigation Rendering ---
        
        const renderModuleNavigation = (sections) => {
            const moduleCards = sections.map((module, index) => {
                const moduleNumber = index + 1;
                const video = module.videos[0]; 
                
                const displayTitle = `Module ${moduleNumber}`;
                const isActive = currentModuleTitle.includes(displayTitle);

                return `
                    <div onclick="window.playModule('${displayTitle}', '${video.title}', '${video.videoStreams[0].url}', '${video.videoStreams[0].quality}', '${video.description}')"
                        class="module-card transition-all ${isActive ? 'active' : ''}"
                        title="${video.title}"
                    >
                        <span class="text-xl font-bold text-primary">${displayTitle}</span>
                    </div>
                `;
            }).join('');

            return `
                <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">KAVACH Modules (7 Total)</h3>
                <div class="module-list-container">
                    ${moduleCards}
                </div>
            `;
        };


        // --- Global Actions ---

        window.playModule = (moduleTitle, videoTitle, videoUrl, quality = '720p', description = '') => {
            currentVideoUrl = videoUrl;
            currentVideoTitle = videoTitle;
            currentModuleTitle = moduleTitle;
            currentVideoDescription = description; // Store description
            currentVideo = { title: videoTitle, url: videoUrl, quality: quality };
            aiResultText = ""; // Clear previous AI result when switching videos
            
            renderApp();
            
            // Enable AI buttons once content is loaded (Requires https://)
            const qnaButton = document.getElementById('qna-button');
            const summaryButton = document.getElementById('summary-button');

            if (qnaButton) qnaButton.disabled = false;
            if (summaryButton) summaryButton.disabled = false;
        };

        window.setVideoQuality = (quality) => {
            if (!currentVideo) return;
            currentVideo.quality = quality;
            renderApp();
        };

        window.renderMessageBox = (title, message, type) => {
            const color = type === 'warning' ? 'bg-yellow-500' : 'bg-primary';
            const icon = type === 'warning' ? 'AlertTriangle' : 'CheckCircle';

            const modalHtml = `
                <div id="msg-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                        <div class="p-4 ${color} text-white flex items-center">
                            ${getIcon(icon, 'w-6 h-6 mr-2')}
                            <h3 class="text-lg font-bold">${title}</h3>
                        </div>
                        <div class="p-4 text-gray-700">
                            <p class="mb-4">${message}</p>
                            <button onclick="document.getElementById('msg-box').remove()"
                                class="w-full py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium transition-all"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        };
        
        const attachEventListeners = () => {
            document.getElementById('toggle-network-btn')?.addEventListener('click', () => {
                isOffline = !isOffline;
                // Simulate new speed if we go online
                simulatedSpeed = isOffline ? 'Offline' : (Math.random() * 5 + 0.5).toFixed(1) + ' Mbps';
                loadContentLogic(); 
            });

            document.getElementById('clear-cache-btn')?.addEventListener('click', () => {
                localStorage.removeItem(CACHE_KEY);
                window.renderMessageBox("Cache Cleared", "Local content cache has been cleared. The app will attempt to load fresh data on the next reload.", 'warning');
                setTimeout(() => window.location.reload(), 1500);
            });
            
            // Initial state for AI buttons (ensure they are disabled until a video is clicked)
            const qnaButton = document.getElementById('qna-button');
            const summaryButton = document.getElementById('summary-button');

            if (qnaButton) qnaButton.disabled = isAiLoading;
            if (summaryButton) summaryButton.disabled = isAiLoading;
        };

        // --- Data Loading and Caching Logic ---

        const loadContentLogic = async () => {
            currentStatus = 'Loading... Parsing embedded content...';
            renderApp();

            await new Promise(resolve => setTimeout(resolve, MOCK_FETCH_DELAY)); 

            let dataToLoad = null;

            if (!isOffline && navigator.onLine) {
                dataToLoad = EMBEDDED_KAVACH_DATA;
                localStorage.setItem(CACHE_KEY, JSON.stringify(dataToLoad));
                currentStatus = 'Loaded latest content'; // Shortened status
                isOffline = false;
            } else {
                const cachedData = localStorage.getItem(CACHE_KEY);
                if (cachedData) {
                    dataToLoad = JSON.parse(cachedData);
                    currentStatus = 'Loaded from cache'; // Shortened status
                } else {
                    dataToLoad = EMBEDDED_KAVACH_DATA;
                    currentStatus = 'No cache, using default content'; // Shortened status
                }
                isOffline = true;
                simulatedSpeed = 'Offline';
            }
            
            appData = dataToLoad;

            // Set the first video as the default player content on load
            if (appData && appData.sections && appData.sections.length > 0 && appData.sections[0].videos.length > 0) {
                 const firstModule = appData.sections[0];
                 const firstVideo = firstModule.videos[0];
                 window.playModule(`Module 1`, firstVideo.title, firstVideo.videoStreams[0].url, firstVideo.videoStreams[0].quality, firstVideo.description);
            } else {
                renderApp(); 
            }
        };

        // --- Firebase Initialization (Standalone Compatible) ---

        const initializeFirebase = async () => {
            if (typeof __initial_auth_token !== 'undefined') {
                 try {
                     const { initializeApp: _initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                     const authModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                     const firestoreModule = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                     
                     initializeApp = _initializeApp;
                     ({ getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = authModule);
                     ({ getFirestore, setLogLevel } = firestoreModule);

                     setLogLevel('debug');

                     app = initializeApp(firebaseConfig);
                     auth = getAuth(app);
                     db = getFirestore(app);

                     onAuthStateChanged(auth, (user) => {
                         if (user) { userId = user.uid; } else { userId = 'Anonymous (Canvas)'; }
                         isAuthReady = true;
                         loadContentLogic();
                     });
                     
                     if (initialAuthToken) {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } else {
                         await signInAnonymously(auth);
                     }
                     return; 
                 } catch (e) {
                     console.warn("Could not load Firebase SDKs. Running in standalone mode.", e);
                     userId = 'Anonymous (Standalone)';
                 }
            }
            
            // Standalone Execution Fallback
            isAuthReady = true;
            loadContentLogic();
        };

        window.onload = initializeFirebase;
    </script>
</body>
</html>
